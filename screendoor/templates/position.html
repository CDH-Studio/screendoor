{% extends 'base_logged_in.html' %}
{% load string_interpolation %}
{% load static %}
{% block content %}
<!-- Beginning of position display -->
{% if position is not None %}
<div class="container positions">
  <a href="{% url 'positions' %}" class="btn-flat blue-text sort-positions">‚Üê  {{ positionText.back_to_positions }}</a>
  <h6 class="btn-flat disabled"></h6>
  <form method="post" action="{% url 'edit' %}" id="save-position" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="row">
      <!--Beginning of position card -->
      <div class="col card white hoverable">
        <div class="card-content col s12">
          <div class="row valign-wrapper">
            <input type="hidden" formaction="{% url 'edit' %}" name="save-position" value="true">
            <input type="hidden" name="position-id" value="{{ position.id }}">
            <input type="hidden" class="hidden" name="position-title" value="{{ position.position_title }}">
            <h4 name="position-title" id="title" class="col s7 left left-align position-header grey-text text-darken-3">{{ position.position_title }}</h4>
            <!-- Applicants summary information -->
            <div class="applicant-summary-cards col s6 right">
              {% if applicants %}
              <span class="applicant-summary-card card-panel white-text blue right {% if position.mean_score <= 33 %}
                           red
                           {% elif position.mean_score > 33 and position.mean_score <= 66 %}
                           orange
                           {% elif position.mean_score > 66 and position.mean_score <= 100 %}
                           green
                           {% endif %}">{{ userVisibleText.average_score }}: {{ position.mean_score }}</span>
              <span class="applicant-summary-card white-text blue card-panel right">{{ position.number_applicants }} {% if position.number_applicants > 1 %}{{ userVisibleText.applicants }}{% else %}{{ userVisibleText.applicant }}{% endif %}</span>
              {% endif %}
            </div>
          </div>
          <!-- Upload Applications and Delete buttons -->
          <div class="row left">
            <div class="position-view-buttons">
              <a class="btn-flat blue-text modal-trigger" href="#upload-applications-modal">{{ userVisibleText.upload_applications }}</a>
              <a class="btn-flat blue-text modal-trigger" href="#delete-modal">{{ userVisibleText.delete }}</a>
              <input type="button" class="btn-flat" id="expand-all" value="{{ userVisibleText.expand_all }}">
              <input type="button" class="btn-flat" id="collapse-all" value="{{ userVisibleText.collapse_all }}">
            </div>
          </div>
          <!-- Position row 1 headers -->
          <table class="highlight editable">
            <thead class="collapse">
              <tr>
                <th colspan="1"><i class="collapse-arrows material-icons grey-text text-darken-2">keyboard_arrow_down</i></th>
                <th colspan="5">{{ positionText.classification }}</th>
                <th colspan="10">{{ positionText.reference_number }}</th>
                <th colspan="10">{{ positionText.selection_process_number }}</th>
              </tr>
            </thead>
            <!-- Position row 1 body -->
            <tbody>
              <tr>
                <th colspan="1"></th>
                <input type="hidden" class="hidden" name="position-classification" value="{{ position.classification }}">
                <td colspan="5" name="position-classification">{{ position.classification }}</td>
                <input type="hidden" class="hidden" name="position-reference" value="{{ position.reference_number }}">
                <td colspan="10" name="position-reference">{{ position.reference_number }}</td>
                <input type="hidden" class="hidden" name="position-selection" value="{{ position.selection_process_number }}">
                <td colspan="10" name="position-selection">{{ position.selection_process_number }}</td>
              </tr>
            </tbody>
            <!-- Position row 2 headers -->
            <thead class="collapse">
              <tr>
                <th colspan="1"><i class="collapse-arrows material-icons grey-text text-darken-2">keyboard_arrow_down</i></th>
                <th colspan="5">{{ positionText.date_closed }}</th>
                <th colspan="4">{{ positionText.number_of_positions }}</th>
                <th colspan="6">{{ positionText.salary_range }}</th>
                <th colspan="10">{{ positionText.open_to }}</th>
              </tr>
            </thead>
            <!-- Position row 2 body -->
            <tbody>
              <tr>
                <th colspan="1"></th>
                <input type="hidden" class="hidden" name="position-date-closed" value='{{ position.date_closed|date:"M d, Y" }}'>
                <td colspan="5" name="position-date-closed">{{ position.date_closed|date:"M d, Y" }}</td>
                <input type="hidden" class="hidden" name="position-num-positions" value='{{ position.num_positions }}'>
                <td colspan="4" name="position-num-positions">{{ position.num_positions }}</td>
                <input type="hidden" class="hidden" name="position-salary-range" value='${{ position.salary_min }} - ${{ position.salary_max }}'>
                <td colspan="6" name="position-salary-range">${{ position.salary_min }} - ${{ position.salary_max }}</td>
                <input type="hidden" class="hidden" name="position-open-to" value='{{ position.open_to }}'>
                <td colspan="10" name="position-open-to">{{ position.open_to }}</td>
              </tr>
            </tbody>
            <!-- Position row 3 header -->
            <thead class="collapse">
              <tr>
                <th colspan="1"><i class="collapse-arrows material-icons grey-text text-darken-2">keyboard_arrow_down</i></th>
                <th colspan="25">{{ positionText.position_information }}</th>
              </tr>
            </thead>
            <!-- Position row 3 body -->
            <tbody>
              <tr>
                <th colspan="1"></th>
                <input type="hidden" class="hidden" name="position-description" value='{{ position.description }}'>
                <td colspan="25" name="position-description">{{ position.description }}</td>
              </tr>
            </tbody>
            <!-- Position education and experience rows -->
            <h5>{{ userVisibleText.education_and_experience_criteria }}</h5>
            {% for req in position.requirement_set.all|dictsort:'requirement_type'|dictsort:'abbreviation' %}
            <!-- ifchanged executes only for distinct values without repetition -->
            {% ifchanged %}
            <thead class="collapse">
              <tr>
                <!-- Requirement type, e.g. education, experience, assets -->
                <th colspan="1"><i class="collapse-arrows material-icons grey-text text-darken-2">keyboard_arrow_right</i></th>
                <th colspan="25">{{ req.requirement_type }}</th>
              </tr>
            </thead>
            {% endifchanged %}
            <tbody class="hide">
              <tr>
                <!-- Requirement abbreviation, e.g. EX1, and description -->
                <th colspan="1"></th>
                <input type="hidden" class="hidden" name="position-requirement{{ forloop.counter }}" value='{{ req.abbreviation }}: {{ req.description|linebreaksbr }}'>
                <td colspan="25" name="position-requirement{{ forloop.counter }}">{{ req.abbreviation }}: {{ req.description|linebreaksbr }}</td>
              </tr>
            </tbody>
            {% endfor %}
          </table>
          <!-- Date and time position was added -->
          <div class="row position-bottom-buttons">
            <div class="col s6 left" id="import-position-buttons">
              <input type="button" id="edit-button" name="edit" class="position-edit-btn btn-flat blue-text modal-trigger" value="{{ userVisibleText.edit }}">
              <input type="button" id="save-button" name="save" class="btn-pad btn-flat blue-text modal-trigger hide" value="Save">
              <data id="ok-button-text" value="{{ positionText.ok }}"></data>
              <data id="cancel-button-text" value="{{ positionText.cancel }}"></data>
            </div>
            <h6 class="btn-flat right black-text">{{ userVisibleText.position_added }}: {{ position.created }}</h6>
          </div>
        </div>
      </div>
    </div>
  </form>
  <!-- Error message if position is invalid/cannot be displayed -->
  {% else %}
  <h5>{{ positionText.cannot_display_position }}</h5>
  <!-- End of position display -->
  {% endif %}
  <!-- Beginning of applicants display -->
  {% if applicants  %}
  <!-- Applications anchor -->
  <a id="applications"></a>
  <!-- <form action="" method="POST" enctype="multipart/form-data" class="sort-applications right">
       {% csrf_token %}
       <h6 class="btn-flat disabled sortby-button">Filter</h6>
       <button type="submit" class="sort-button btn-flat" value="">Percentile</button>
       </form> -->
  <!-- Application field headers -->
  <div class="col">
    <table class="applicant-table">
      <thead class="applicant-table-header">
        <tr>
          <th colspan="2"><!-- <i class="material-icons sort-icon">sort</i> --></th>
          <th colspan="16" class="applicant-id-text"><a href="{% if '-applicant_id' in sort %}{% url 'sort_applicants' position.reference_number position.id 'applicant_id' %}{% elif 'applicant_id' in sort %}{% url 'sort_applicants' position.reference_number position.id '-applicant_id' %}{% else %}{% url 'sort_applicants' position.reference_number position.id '-applicant_id' %}{% endif %}" class="applicant-sort {% if 'applicant_id' in sort %}blue-text{% endif %}">
            {{ positionText.applicant_id }}
            {% if '-applicant_id' in sort %}
            <i class="applicant-sort-arrow material-icons">arrow_drop_up</i>
            {% elif 'applicant_id' in sort %}
            <i class="applicant-sort-arrow material-icons">arrow_drop_down</i>
            {% endif %}
          </a></th>
          <th colspan="12"><a href="{% if '-classification_names' in sort %}{% url 'sort_applicants' position.reference_number position.id 'classification_names' %}{% elif 'classification_names' in sort %}{% url 'sort_applicants' position.reference_number position.id '-classification_names' %}{% else %}{% url 'sort_applicants' position.reference_number position.id '-classification_names' %}{% endif %}" class="{% if 'classification_names' in sort %}blue-text{% endif %}">
            <span class="applicant-sort">{{ positionText.classifications }}</span>
            {% if '-classification_names' in sort %}
            <i class="applicant-sort-arrow material-icons">arrow_drop_up</i>
            {% elif 'classification_names' in sort %}
            <i class="applicant-sort-arrow material-icons">arrow_drop_down</i>
            {% endif %}
            </a>
          </th>
          <th colspan="14" class="streams-text"><a href="{% if '-stream_count' in sort %}{% url 'sort_applicants' position.reference_number position.id 'stream_count' %}{% elif 'stream_count' in sort %}{% url 'sort_applicants' position.reference_number position.id '-stream_count' %}{% else %}{% url 'sort_applicants' position.reference_number position.id '-stream_count' %}{% endif %}" class="applicant-sort {% if 'stream_count' in sort %}blue-text{% endif %}">
            {{ positionText.streams }}
            {% if '-stream_count' in sort %}
            <i class="applicant-sort-arrow material-icons">arrow_drop_up</i>
            {% elif 'stream_count' in sort %}
            <i class="applicant-sort-arrow material-icons">arrow_drop_down</i>
            {% endif %}
          </a>
          </th>
          <th colspan="8" class="score-text">
            <a href="{% if '-percentage_correct' in sort %}{% url 'sort_applicants' position.reference_number position.id 'percentage_correct' %}{% elif 'percentage_correct' in sort %}{% url 'sort_applicants' position.reference_number position.id '-percentage_correct' %}{% else %}{% url 'sort_applicants' position.reference_number position.id '-percentage_correct' %}{% endif %}" class="applicant-sort {% if 'percentage_correct' in sort %}blue-text{% endif %}">
              {{ positionText.score }}
              {% if '-percentage_correct' in sort %}
              <i class="applicant-sort-arrow material-icons">arrow_drop_up</i>
              {% elif 'percentage_correct' in sort %}
              <i class="applicant-sort-arrow material-icons">arrow_drop_down</i>
              {% endif %}
            </a>
          </th>
          <th colspan="4"></th>
        </tr>
      </thead>
    </table>
  </div>
  {% for applicant in applicants %}
  <!-- Mock application 1 -->
  <div class="col s12 application-preview card card-content white hoverable">
    <!-- Position row 1 body -->
    <table class="highlight applicant-table">
      <tbody>
        <tr>
          <td colspan="2"><i class="applicant-icon applicant-preview-icon material-icons small
                                    {% if applicant.percentage_correct <= 33 %}
                                    red-text
                                    {% elif applicant.percentage_correct > 33 and applicant.percentage_correct <= 66 %}
                                    orange-text
                                    {% elif applicant.percentage_correct > 66 and applicant.percentage_correct <= 100 %}
                                    green-text
                                    {% endif %}
                                    text-darken-2">person</i></td>
          <td colspan="16"><a href="{% url 'application' applicant.applicant_id %}" class="application-button modal-trigger blue-text sort-applications">{{ applicant.applicant_id }}</a></td>
          <td colspan="12">
            {% for classification in applicant.classifications_set %}
            {{ classification.classification_substantive }}
            {% if classification.classification_current is not None %},
            {{ classification.classification_current }}
            {% endif %}
            {% endfor %}</td>
          <td colspan="14">
            {% for stream in applicant.streams_set %}
            {% if stream.stream_name is not None %}
            {{ stream.stream_name }}
            {% endif %}
            {% endfor %}</td>
          <td colspan="9"><span class="applicant-id
                                       {% if applicant.percentage_correct <= 33 %}
                                       red-text
                                       {% elif applicant.percentage_correct > 33 and applicant.percentage_correct <= 66 %}
                                       orange-text
                                       {% elif applicant.percentage_correct > 66 and applicant.percentage_correct <= 100 %}
                                       green-text
                                       {% endif %}
                                       text-darken-2 applicant-question-total">{{ applicant.number_yes_responses }}</span><span class="">/{{ applicant.number_questions }} ({{ applicant.percentage_correct }}%)</span></td>
          <td colspan="3"><a href="{% url 'sbr' applicant.applicant_id %}" class="material-icons red-text">picture_as_pdf</a></td>
        </tr>
      </tbody>
    </table>
  </div>
  {% endfor %}
  {% endif %}
  <!-- End of applicants display -->
</div>
<!-- Modal delete position confirmation pop-up -->
<div id="delete-modal" class="modal">
  <div class="modal-content">
    <h5>{{ userVisibleText.confirm_delete_header }}</h5>
    <p>{{ userVisibleText.confirm_delete }}</p>
    <h6>{{ position.position_title }}</h6>
  </div>
  <form action="" method="POST">
    {% csrf_token %}
    <div class="modal-footer">
      <input type="hidden" id="delete-confirm-id" name="position-id" value="{{ position.id }}">
      <input type="submit" formaction="{% url 'delete' %}" id="delete-confirm-button" class="btn-flat blue-text position-button" name="delete" value="{{ userVisibleText.delete }}">
      <a href="#!" class="modal-close btn-flat blue-text position-button">Cancel</a>
    </div>
  </form>
</div>

<!-- Modal upload applications pop-up -->
<div id="upload-applications-modal" class="modal">
  <form id="upload-applications-form" action="{% url 'upload-applications' %}" method="POST" enctype="multipart/form-data">
    {% csrf_token %}
    <div class="modal-content">
      <h5>{{ applicationsForm.title }}</h5>
      <p id="upload-applications-text">{{ applicationsForm.description|interpolate:position.position_title }}</p>
      <!-- PDF/File input -->
      <div class="file-field input-field">
        <div class="btn-small">
          <span>{{ applicationsForm.browse }}</span>
          <!-- Input accepts multiple PDF file -->
          <input type="file" name="pdf" id="pdf" class="btn-small" value="{{ applicationsForm.browse }}" required multiple>
        </div>
        <div class="file-path-wrapper">
          <input id="pdf_path_input" class="file-path validate" type="text"
                 placeholder="{{ applicationsForm.choose_files }}" />
        </div>
      </div>
    </div>
    <!-- Upload and cancel buttons -->
    <div class="modal-footer">
      <input type="hidden" id="upload-applications-id" name="position-id" value="{{ position.id }}">
      <input type="hidden" id="reload-url" value="{% url 'position' position.reference_number position.id %}">
      <input type="hidden" id="task-id" value="{{ task_id }}">
      <input type="hidden" id="task-url" value="{% url 'task_status' task_id %}">
      <input type="hidden" id="calculating-applicants-text" value="{{ applicationsForm.calculating_number_applicants }}">
      <input type="hidden" id="upload-error-text" value="{{ applicationsForm.upload_error }}">
      <input type="hidden" id="progress-text-value" value="{{ applicationsForm.processing_applicant }} <span id='current-number'></span> {{ applicationsForm.of }} <span id='total-number'></span>">
      <input type="submit" id="upload-applications-button" class="btn-flat blue-text position-button" name="upload-applications" value="{{ applicationsForm.upload }}">
      <a href="#!" class="modal-close btn-flat blue-text position-button">{{ userVisibleText.cancel }}</a>
    </div>
  </form>
</div>

<!-- Application processing modal -->
<!-- Modal Structure -->
<div id="processing-modal" class="modal">
  <div class="modal-content">
    <div class="row">
      <h5>{{ positionText.processing_applications }}</h5>
      <div id="upload-applications-text">
        <p>{{ positionText.processing_detail_1 }}</p>
        <p id="files-processing"></p>
        <p>{{ positionText.processing_detail_2 }}</p>
        <br>
      </div>
      <!-- Hidden inputs with values for JavaScript -->
      <input type="hidden" id="task-id" value="{{ task_id }}">
      <!-- Hidden loading bar div -->
      <div id="progress-div" class="container">
        <div class="row">
          <div class="progress center">
            <div id="progress-bar" class="determinate" style="width: 0%;"></div>
          </div>
        </div>
        <div class="row">
          <div class="progress-indicator">
            <h6 class="col s9 progress-text"><span id="progress-text"></span></h6>
            <h6 class="col s3 loading"></h6>
          </div>
        </div>
      </div>
      <!-- <div class="modal-footer"> -->
      <!-- <a href="#!" class="modal-close waves-effect waves-green btn-flat">Close</a> -->
      <!-- </div> -->
    </div>
  </div>
  <!-- MaterializeCSS JS library  -->
  <script src="{% static 'js/materialize.js' %}"></script>
  <!-- Misc helper functions -->
  <script src="{% static 'js/helper-functions.js' %}"></script>
  <!-- Script for initializing modal pop-ups -->
  <script src="{% static 'js/modal.js' %}"></script>
  <!-- Script for local storage items -->
  <script src="{% static 'js/localstorage.js' %}"></script>
  <!-- Script for applicant upload loading screen -->
  <script src="{% static 'js/applicant-upload.js' %}"></script>
  <!-- Script for expanding and collapsing table rows -->
  <script src="{% static 'js/tables.js' %}"></script>
  <!-- Script for editing table values -->
  <script src="{% static 'js/position-edit.js' %}"></script>
  <!-- Inline script requiring Django variables -->
  {% endblock %}
